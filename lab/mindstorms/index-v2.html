<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mindstorms v2 ‚Äî Papert Microworlds</title>
<style>
:root {
  --bg: #0a0f1a; --bg2: #0d1520; --bg3: #060d18;
  --border: #1a3040; --cyan: #5ce0d6; --orange: #e8a87c;
  --green: #4ade80; --red: #f87171; --purple: #a78bfa;
  --text: #ddd; --muted: #88a0b8; --dim: #556;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: Georgia, serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
button { font-family: inherit; cursor: pointer; }
code, .mono { font-family: 'Courier New', monospace; }

/* NAV */
.topbar { text-align:center; padding:20px 10px 8px; }
.topbar h1 { font-size:1.6rem; color:var(--cyan); letter-spacing:1px; }
.topbar .sub { color:var(--dim); font-size:0.85rem; font-style:italic; margin-top:2px; }

.nav { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; padding:10px; background:var(--bg2); border-bottom:2px solid var(--border); position:sticky; top:0; z-index:100; }
.nav button { background:var(--bg); color:var(--muted); border:1px solid var(--border); padding:6px 11px; border-radius:16px; font-size:0.75rem; transition:all .2s; }
.nav button:hover, .nav button.active { background:var(--cyan); color:var(--bg); border-color:var(--cyan); }

/* SECTIONS */
.section { display:none; padding:30px 15px; max-width:900px; margin:0 auto; min-height:80vh; }
.section.active { display:block; }
.section h2 { color:var(--cyan); font-size:1.5rem; margin-bottom:6px; }
.section .desc { color:var(--muted); font-size:0.9rem; margin-bottom:20px; line-height:1.5; }

.panel { background:var(--bg2); border-radius:10px; padding:20px; margin:15px 0; border:1px solid var(--border); }
.panel-title { color:var(--cyan); font-size:1rem; margin-bottom:10px; font-weight:bold; }

.quote { background:var(--bg2); border-left:3px solid var(--cyan); padding:12px 16px; margin:20px 0; font-style:italic; border-radius:0 8px 8px 0; color:var(--muted); font-size:0.9rem; }
.quote .attr { display:block; text-align:right; color:var(--dim); font-style:normal; margin-top:6px; font-size:0.8rem; }

canvas { display:block; width:100%; border-radius:8px; border:1px solid var(--border); background:var(--bg3); }
textarea, input[type=text] { width:100%; background:var(--bg3); border:1px solid var(--border); color:var(--cyan); padding:10px; font-family:'Courier New',monospace; font-size:0.85rem; border-radius:6px; resize:vertical; }
.btn-row { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
.btn { background:var(--bg); color:var(--cyan); border:1px solid var(--border); padding:7px 13px; border-radius:6px; font-size:0.8rem; transition:all .2s; }
.btn:hover { background:var(--cyan); color:var(--bg); }
.btn-sm { padding:4px 10px; font-size:0.72rem; border-radius:12px; background:var(--bg2); color:var(--muted); border:1px solid var(--border); }
.btn-sm:hover { color:var(--cyan); border-color:var(--cyan); }
.btn-active { background:var(--cyan)!important; color:var(--bg)!important; border-color:var(--cyan)!important; }

/* BODY SYNTONIC */
.body-arena { position:relative; width:100%; height:400px; background:var(--bg3); border-radius:8px; border:1px solid var(--border); overflow:hidden; }
.body-avatar { position:absolute; transition: all 0.4s ease; }
.body-trail { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
.arrow-pad { display:grid; grid-template-columns:repeat(3,60px); grid-template-rows:repeat(2,50px); gap:4px; justify-content:center; margin-top:10px; }
.arrow-pad button { font-size:1.3rem; background:var(--bg2); border:1px solid var(--border); color:var(--cyan); border-radius:8px; }
.arrow-pad button:hover { background:var(--cyan); color:var(--bg); }
.arrow-pad button:active { transform:scale(0.95); }

/* MAZE */
.maze-wrap { position:relative; width:100%; overflow:hidden; }

/* MICROWORLD BUILDER */
.rule-editor { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.rule-editor label { color:var(--muted); font-size:0.8rem; display:block; margin-bottom:4px; }
.rule-editor input { width:100%; }
.geo-canvas-wrap { display:flex; gap:10px; align-items:start; flex-wrap:wrap; }

/* JUGGLING */
.juggle-vis { display:flex; justify-content:center; align-items:end; height:300px; position:relative; background:var(--bg3); border-radius:8px; border:1px solid var(--border); overflow:hidden; }
.juggle-hand { width:40px; height:20px; background:var(--muted); border-radius:10px 10px 0 0; position:absolute; bottom:40px; }
.juggle-ball { width:24px; height:24px; border-radius:50%; position:absolute; transition: all 0.3s ease; }

/* OBJECT TO THINK WITH */
.obj-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px; }
.obj-card { background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:15px; cursor:pointer; transition:all .2s; }
.obj-card:hover { border-color:var(--cyan); transform:translateY(-2px); }
.obj-card.active { border-color:var(--cyan); background:var(--bg2); }
.obj-card h4 { color:var(--cyan); margin-bottom:5px; font-size:0.95rem; }
.obj-card p { color:var(--muted); font-size:0.8rem; line-height:1.4; }

.footer { text-align:center; padding:30px 15px; color:var(--dim); font-size:0.8rem; border-top:1px solid var(--border); margin-top:30px; }

@media(max-width:600px) {
  .rule-editor { grid-template-columns:1fr; }
  .arrow-pad { grid-template-columns:repeat(3,50px); grid-template-rows:repeat(2,44px); }
}
</style>
</head>
<body>

<div class="topbar">
  <h1>MINDSTORMS</h1>
  <div class="sub">Seymour Papert's Microworlds ‚Äî Interactive</div>
</div>

<div class="nav" id="nav"></div>

<div class="section" id="sec-turtle">
  <h2>üê¢ Turtle Graphics Lab</h2>
  <p class="desc">A full Logo-style environment. Type commands, watch the turtle draw. This is Papert's core idea: the computer as material-to-think-with.</p>
  <div class="panel">
    <div class="panel-title">Commands</div>
    <p style="color:var(--muted);font-size:0.82rem;line-height:1.6">
      <code>FD n</code> forward ¬∑ <code>BK n</code> back ¬∑ <code>RT n</code> right ¬∑ <code>LT n</code> left ¬∑ <code>PU</code> pen up ¬∑ <code>PD</code> pen down ¬∑ <code>REPEAT n [...]</code> ¬∑ <code>CS</code> clear ¬∑ <code>SETCOLOR #hex</code> ¬∑ <code>TO name ... END</code> define procedure ¬∑ <code>SETWIDTH n</code>
    </p>
  </div>
  <canvas id="turtleCanvas" height="420"></canvas>
  <textarea id="turtleCode" rows="3" placeholder="REPEAT 4 [FD 100 RT 90]"></textarea>
  <div class="btn-row">
    <button class="btn" onclick="T.run()">‚ñ∂ Run</button>
    <button class="btn" onclick="T.clear()">üóë Clear</button>
    <button class="btn" onclick="T.save()">üíæ Save PNG</button>
  </div>
  <div class="btn-row" id="turtlePresets"></div>
  <div id="turtleLog" style="color:var(--muted);font-size:0.8rem;margin-top:8px;min-height:20px;"></div>
  <div class="quote">"The child programs the computer and, in doing so, both acquires a sense of mastery over a piece of the most modern and powerful technology and establishes an intimate contact with some of the deepest ideas from science, from mathematics, and from the art of intellectual model building."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-body">
  <h2>üèÉ Body Syntonic Geometry</h2>
  <p class="desc">Papert's key insight: you understand circles by <em>being</em> the turtle. Use the arrows to walk forward and turn. Feel the geometry with your body. Watch the path you trace ‚Äî then try to make a square, a triangle, a circle.</p>
  <div class="body-arena" id="bodyArena">
    <canvas id="bodyTrail" width="800" height="400"></canvas>
    <div class="body-avatar" id="bodyAvatar"></div>
  </div>
  <div class="arrow-pad">
    <button onclick="B.turn(-15)">‚Ü∞ LT</button>
    <button onclick="B.forward(20)">‚¨Ü FD</button>
    <button onclick="B.turn(15)">‚Ü± RT</button>
    <button onclick="B.forward(-20)">‚¨á BK</button>
    <button onclick="B.clear()" style="font-size:0.8rem">Clear</button>
    <button onclick="B.togglePen()" id="bodyPenBtn" style="font-size:0.8rem">Pen ‚úèÔ∏è</button>
  </div>
  <div style="text-align:center;margin-top:10px;">
    <span id="bodyInfo" style="color:var(--muted);font-size:0.82rem;">Angle: 0¬∞ ¬∑ Steps: 0</span>
  </div>
  <div class="panel" style="margin-top:15px;">
    <div class="panel-title">üß™ Challenges</div>
    <p style="color:var(--muted);font-size:0.85rem;line-height:1.6">
      <strong>Square:</strong> FD √ó 4, RT 90¬∞ at each corner<br>
      <strong>Triangle:</strong> FD √ó 3, RT 120¬∞ (exterior angle!)<br>
      <strong>Circle:</strong> FD tiny + RT tiny, many times<br>
      <strong>Star:</strong> FD + RT 144¬∞, five times
    </p>
  </div>
  <div class="quote">"What we learn about learning from the Turtle is that knowledge begins with action ‚Äî not contemplation."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-maze">
  <h2>üßÆ Mathland</h2>
  <p class="desc">Navigate a maze using only angle and distance commands. In Mathland, math is the native language ‚Äî you can't move without it. No hand-holding, no multiple choice. Just you, the turtle, and geometry.</p>
  <canvas id="mazeCanvas" height="420"></canvas>
  <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;align-items:center;">
    <input type="text" id="mazeCmd" placeholder="FD 50 or RT 45" style="flex:1;min-width:150px;" onkeydown="if(event.key==='Enter')M.exec()">
    <button class="btn" onclick="M.exec()">Go</button>
    <button class="btn" onclick="M.reset()">Reset</button>
    <button class="btn" onclick="M.newMaze()">New Maze</button>
  </div>
  <div id="mazeLog" style="color:var(--muted);font-size:0.82rem;margin-top:8px;min-height:20px;"></div>
  <div id="mazeStatus" style="color:var(--green);font-size:0.9rem;margin-top:4px;min-height:20px;font-weight:bold;"></div>
  <div class="quote">"What would happen if children who can't do math grew up in Mathland ‚Äî an environment as rich in mathematical structures as France is rich in French?"<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-debug">
  <h2>üêõ Bug as Feature</h2>
  <p class="desc">Write a program that has a bug. Instead of "wrong," the system shows what your code <em>actually</em> made. The goal isn't the right answer ‚Äî it's understanding the gap between intention and reality. Debug by thinking, not by being told.</p>
  <div class="panel">
    <div class="panel-title">Your Program</div>
    <textarea id="debugCode" rows="3" placeholder="Try: REPEAT 4 [FD 80 RT 80]  (what shape is this?)"></textarea>
    <div class="btn-row">
      <button class="btn" onclick="D.run()">‚ñ∂ Run & Analyze</button>
      <button class="btn" onclick="D.clear()">Clear</button>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    <div style="flex:1;min-width:280px;">
      <canvas id="debugCanvas" height="300"></canvas>
    </div>
    <div id="debugAnalysis" class="panel" style="flex:1;min-width:250px;font-size:0.85rem;color:var(--muted);line-height:1.6;">
      Run a program to see analysis...
    </div>
  </div>
  <div class="panel" style="margin-top:15px;">
    <div class="panel-title">üî¨ Guided Debugging Puzzles</div>
    <div id="debugPuzzles"></div>
  </div>
  <div class="quote">"The question to ask about a program is not whether it is right or wrong, but whether it is fixable."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-micro">
  <h2>üåê Microworld Builder</h2>
  <p class="desc">Create your own microworld by changing what FD and RT mean. In Euclidean space, FD goes straight and RT rotates. But what if FD curved? What if RT also moved you? Different rules create different geometries.</p>
  <div class="panel">
    <div class="panel-title">Geometry Rules</div>
    <div class="btn-row" style="margin-bottom:10px;">
      <button class="btn-sm" onclick="MW.preset('euclidean')">Euclidean</button>
      <button class="btn-sm" onclick="MW.preset('hyperbolic')">Hyperbolic</button>
      <button class="btn-sm" onclick="MW.preset('spherical')">Spherical</button>
      <button class="btn-sm" onclick="MW.preset('drunk')">Drunk Turtle</button>
      <button class="btn-sm" onclick="MW.preset('spiral')">Spiral Space</button>
      <button class="btn-sm" onclick="MW.preset('mirror')">Mirror World</button>
    </div>
    <div class="rule-editor">
      <div>
        <label>FD multiplier (distance scale)</label>
        <input type="range" id="mwFdMul" min="0.1" max="3" step="0.1" value="1" oninput="MW.updateLabel()">
        <span id="mwFdMulV" style="color:var(--cyan);font-size:0.8rem;">1.0</span>
      </div>
      <div>
        <label>FD curvature (0=straight)</label>
        <input type="range" id="mwFdCurve" min="-2" max="2" step="0.1" value="0" oninput="MW.updateLabel()">
        <span id="mwFdCurveV" style="color:var(--cyan);font-size:0.8rem;">0.0</span>
      </div>
      <div>
        <label>RT multiplier (angle scale)</label>
        <input type="range" id="mwRtMul" min="0.1" max="3" step="0.1" value="1" oninput="MW.updateLabel()">
        <span id="mwRtMulV" style="color:var(--cyan);font-size:0.8rem;">1.0</span>
      </div>
      <div>
        <label>RT drift (extra move on turn)</label>
        <input type="range" id="mwRtDrift" min="-2" max="2" step="0.1" value="0" oninput="MW.updateLabel()">
        <span id="mwRtDriftV" style="color:var(--cyan);font-size:0.8rem;">0.0</span>
      </div>
      <div>
        <label>Randomness</label>
        <input type="range" id="mwRandom" min="0" max="1" step="0.05" value="0" oninput="MW.updateLabel()">
        <span id="mwRandomV" style="color:var(--cyan);font-size:0.8rem;">0.0</span>
      </div>
      <div>
        <label>Shrink per step (1=none)</label>
        <input type="range" id="mwShrink" min="0.9" max="1.1" step="0.002" value="1" oninput="MW.updateLabel()">
        <span id="mwShrinkV" style="color:var(--cyan);font-size:0.8rem;">1.000</span>
      </div>
    </div>
  </div>
  <canvas id="microCanvas" height="400"></canvas>
  <textarea id="microCode" rows="2" placeholder="REPEAT 4 [FD 100 RT 90]"></textarea>
  <div class="btn-row">
    <button class="btn" onclick="MW.run()">‚ñ∂ Run</button>
    <button class="btn" onclick="MW.clear()">Clear</button>
  </div>
  <div class="quote">"A microworld is a small, self-contained environment where specific ideas can be explored naturally."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-juggle">
  <h2>ü§π Juggling with Frames</h2>
  <p class="desc">Papert used juggling to teach learning-about-learning. You must give yourself <em>instructions</em> ‚Äî break the skill into sub-procedures. Experience the gap between knowing and doing. Step through each beat and feel the structured programming of your body.</p>
  <div class="panel">
    <div class="panel-title">The Cascade (3-Ball Juggling)</div>
    <p style="color:var(--muted);font-size:0.82rem;margin-bottom:10px;">Each beat is a sub-procedure. Master the decomposition, master the skill.</p>
    <canvas id="juggleCanvas" height="320"></canvas>
    <div class="btn-row" style="justify-content:center;">
      <button class="btn" onclick="J.prev()">‚èÆ Back</button>
      <button class="btn" onclick="J.togglePlay()" id="jugglePlayBtn">‚ñ∂ Play</button>
      <button class="btn" onclick="J.next()">Next ‚è≠</button>
      <button class="btn" onclick="J.reset()">Reset</button>
    </div>
    <div id="juggleStep" style="text-align:center;margin-top:10px;color:var(--cyan);font-size:0.9rem;min-height:50px;line-height:1.5;"></div>
  </div>
  <div class="panel">
    <div class="panel-title">üß© Structured Programming View</div>
    <p style="color:var(--muted);font-size:0.85rem;line-height:1.6;">Juggling decomposed into procedures ‚Äî Papert's insight that breaking complex skills into sub-procedures isn't just good programming, it's good <em>thinking</em>.</p>
    <pre style="background:var(--bg3);padding:12px;border-radius:6px;color:var(--cyan);font-size:0.8rem;overflow-x:auto;margin-top:10px;line-height:1.6;">
TO JUGGLE
  REPEAT FOREVER [
    TOSS_RIGHT
    TOSS_LEFT
  ]
END

TO TOSS_RIGHT         TO TOSS_LEFT
  RIGHT_HAND_THROW      LEFT_HAND_THROW
  LEFT_HAND_CATCH       RIGHT_HAND_CATCH
  WAIT_FOR_PEAK         WAIT_FOR_PEAK
END                   END

TO RIGHT_HAND_THROW   TO LEFT_HAND_THROW
  SCOOP_UP              SCOOP_UP
  RELEASE_AT_45¬∞        RELEASE_AT_45¬∞
  OPEN_FINGERS          OPEN_FINGERS
END                   END</pre>
  </div>
  <div class="quote">"The idea of structured programming becomes a vehicle for thinking about one's own behavior."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="section" id="sec-objects">
  <h2>üí° Object-to-Think-With</h2>
  <p class="desc">The central Papert concept. Take an abstract math idea and give it a physical, visual form you can manipulate directly. These aren't illustrations ‚Äî they're <em>materials</em> for thinking.</p>
  <div class="obj-cards" id="objCards"></div>
  <div class="panel" id="objPlayground" style="margin-top:15px;min-height:300px;">
    <div class="panel-title" id="objTitle">Select an object above...</div>
    <canvas id="objCanvas" height="280" style="display:none;"></canvas>
    <div id="objControls" style="margin-top:10px;"></div>
    <div id="objExplain" style="color:var(--muted);font-size:0.85rem;margin-top:10px;line-height:1.6;"></div>
  </div>
  <div class="quote">"Some of the most crucial steps in mental growth are based not simply on acquiring new skills, but on acquiring new administrative ways to use what one already knows."<span class="attr">‚Äî Seymour Papert</span></div>
</div>

<div class="footer">
  <p>Mindstorms v2 ‚Äî Seymour Papert's Microworlds, Interactive</p>
  <p style="margin-top:4px;">Built from <em>Mindstorms: Children, Computers, and Powerful Ideas</em> (1980)</p>
</div>

<script>
// ============ NAVIGATION ============
const tabs = [
  {id:'turtle', label:'üê¢ Turtle Lab'},
  {id:'body', label:'üèÉ Body Syntonic'},
  {id:'maze', label:'üßÆ Mathland'},
  {id:'debug', label:'üêõ Bug as Feature'},
  {id:'micro', label:'üåê Microworld'},
  {id:'juggle', label:'ü§π Juggling'},
  {id:'objects', label:'üí° Objects'}
];
const nav = document.getElementById('nav');
tabs.forEach((t,i) => {
  const b = document.createElement('button');
  b.textContent = t.label;
  b.onclick = () => showTab(t.id);
  if(i===0) b.classList.add('active');
  nav.appendChild(b);
});
function showTab(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('sec-'+id).classList.add('active');
  nav.querySelectorAll('button').forEach((b,i) => {
    b.classList.toggle('active', tabs[i].id===id);
  });
  window.scrollTo(0,0);
  if(id==='maze' && !M.initialized) M.init();
  if(id==='juggle') J.draw();
  if(id==='body') B.init();
}

// ============ LOGO PARSER (shared) ============
function parseLogo(code, procedures={}) {
  const tokens = code.toUpperCase().replace(/\[/g,' [ ').replace(/\]/g,' ] ').replace(/\n/g,' ').trim().split(/\s+/).filter(Boolean);
  let i = 0;
  // First pass: extract TO...END
  const procs = {...procedures};
  let filtered = [];
  for(let j=0;j<tokens.length;j++){
    if(tokens[j]==='TO'){
      const name = tokens[++j];
      const body = [];
      j++;
      while(j<tokens.length && tokens[j]!=='END') body.push(tokens[j++]);
      procs[name] = body.join(' ');
    } else {
      filtered.push(tokens[j]);
    }
  }
  tokens.length = 0;
  tokens.push(...filtered);
  i = 0;

  function parseBlock() {
    const cmds = [];
    while(i < tokens.length && tokens[i] !== ']') {
      const t = tokens[i];
      if(t==='FD'||t==='FORWARD'){i++;cmds.push({cmd:'FD',val:parseFloat(tokens[i])||0});}
      else if(t==='BK'||t==='BACK'){i++;cmds.push({cmd:'BK',val:parseFloat(tokens[i])||0});}
      else if(t==='RT'||t==='RIGHT'){i++;cmds.push({cmd:'RT',val:parseFloat(tokens[i])||0});}
      else if(t==='LT'||t==='LEFT'){i++;cmds.push({cmd:'LT',val:parseFloat(tokens[i])||0});}
      else if(t==='PU'||t==='PENUP'){cmds.push({cmd:'PU'});}
      else if(t==='PD'||t==='PENDOWN'){cmds.push({cmd:'PD'});}
      else if(t==='CS'||t==='CLEAR'){cmds.push({cmd:'CS'});}
      else if(t==='SETCOLOR'){i++;cmds.push({cmd:'SETCOLOR',val:tokens[i]});}
      else if(t==='SETWIDTH'){i++;cmds.push({cmd:'SETWIDTH',val:parseFloat(tokens[i])||2});}
      else if(t==='REPEAT'){
        i++;const n=parseInt(tokens[i])||1;
        i++;if(tokens[i]==='[')i++;
        const body=parseBlock();
        cmds.push({cmd:'REPEAT',val:n,body});
      }
      else if(procs[t]){
        const sub = parseLogo(procs[t], procs);
        cmds.push(...sub);
      }
      i++;
    }
    return cmds;
  }
  return parseBlock();
}
function flattenCmds(parsed){
  const f=[];
  for(const c of parsed){
    if(c.cmd==='REPEAT'){for(let i=0;i<c.val;i++)f.push(...flattenCmds(c.body));}
    else f.push(c);
  }
  return f;
}

// ============ TURTLE GRAPHICS LAB ============
const T = {
  canvas: null, ctx: null,
  x:0, y:0, angle:-90, pen:true, color:'#5ce0d6', width:2,
  init() {
    this.canvas = document.getElementById('turtleCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.resize();
    window.addEventListener('resize', ()=>this.resize());
    // Presets
    const presets = {
      Square:'REPEAT 4 [FD 100 RT 90]',
      Triangle:'REPEAT 3 [FD 120 RT 120]',
      Circle:'REPEAT 360 [FD 1 RT 1]',
      Star:'REPEAT 5 [FD 120 RT 144]',
      Flower:'REPEAT 12 [REPEAT 360 [FD 0.5 RT 1] RT 30]',
      Spiral:'REPEAT 100 [FD 2 RT 5 SETWIDTH 1]\nREPEAT 100 [FD 2 RT 5]',
      Snowflake:'TO SIDE\nREPEAT 3 [FD 10 RT 60 FD 10 LT 120 FD 10 RT 60 FD 10]\nEND\nREPEAT 6 [SIDE RT 60]',
      Dragon:'TO DRAGON\nFD 4 RT 90\nEND\nREPEAT 200 [DRAGON]',
      Galaxy:'SETCOLOR #A78BFA\nREPEAT 180 [FD 1 RT 2]\nSETCOLOR #5CE0D6\nREPEAT 180 [FD 1.5 RT 2]\nSETCOLOR #E8A87C\nREPEAT 180 [FD 2 RT 2]',
    };
    const wrap = document.getElementById('turtlePresets');
    Object.keys(presets).forEach(k => {
      const b = document.createElement('button');
      b.className='btn-sm';b.textContent=k;
      b.onclick=()=>{document.getElementById('turtleCode').value=presets[k];T.run();};
      wrap.appendChild(b);
    });
  },
  resize() {
    const w = this.canvas.parentElement.clientWidth;
    this.canvas.width = w; this.canvas.height = 420;
    this.clear();
  },
  clear() {
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    this.x=this.canvas.width/2; this.y=this.canvas.height/2;
    this.angle=-90; this.pen=true; this.color='#5ce0d6'; this.width=2;
    this.drawTurtle();
  },
  drawTurtle() {
    const {x,y,angle,ctx}=this;
    const rad=(angle+90)*Math.PI/180, s=12;
    ctx.save();ctx.translate(x,y);ctx.rotate(rad);
    ctx.beginPath();ctx.moveTo(0,-s);ctx.lineTo(-s*.6,s*.6);ctx.lineTo(0,s*.3);ctx.lineTo(s*.6,s*.6);ctx.closePath();
    ctx.fillStyle='#5ce0d6';ctx.globalAlpha=0.9;ctx.fill();ctx.globalAlpha=1;
    ctx.restore();
  },
  exec(c) {
    const rad=this.angle*Math.PI/180;
    if(c.cmd==='FD'||c.cmd==='BK'){
      const d=c.cmd==='FD'?c.val:-c.val;
      const nx=this.x+Math.cos(rad)*d, ny=this.y+Math.sin(rad)*d;
      if(this.pen){this.ctx.beginPath();this.ctx.moveTo(this.x,this.y);this.ctx.lineTo(nx,ny);this.ctx.strokeStyle=this.color;this.ctx.lineWidth=this.width;this.ctx.stroke();}
      this.x=nx;this.y=ny;
    } else if(c.cmd==='RT')this.angle+=c.val;
    else if(c.cmd==='LT')this.angle-=c.val;
    else if(c.cmd==='PU')this.pen=false;
    else if(c.cmd==='PD')this.pen=true;
    else if(c.cmd==='SETCOLOR')this.color=c.val;
    else if(c.cmd==='SETWIDTH')this.width=c.val;
    else if(c.cmd==='CS')this.clear();
  },
  run() {
    const code=document.getElementById('turtleCode').value;
    this.clear();
    try {
      const cmds=flattenCmds(parseLogo(code));
      if(cmds.length>50000){document.getElementById('turtleLog').textContent='Too many commands (max 50000)';return;}
      let i=0;
      const batch=Math.max(1,Math.floor(cmds.length/150));
      const frame=()=>{
        // Clear turtle before drawing
        for(let j=0;j<batch&&i<cmds.length;j++,i++) this.exec(cmds[i]);
        this.drawTurtle();
        if(i<cmds.length) requestAnimationFrame(frame);
        else document.getElementById('turtleLog').textContent=`‚úì ${cmds.length} commands executed`;
      };
      frame();
    } catch(e) {
      document.getElementById('turtleLog').textContent='Error: '+e.message;
    }
  },
  save() {
    const a=document.createElement('a');a.download='turtle.png';a.href=this.canvas.toDataURL();a.click();
  }
};

// ============ BODY SYNTONIC ============
const B = {
  x:0, y:0, angle:0, pen:true, steps:0,
  arena:null, canvas:null, ctx:null, avatar:null,
  initialized: false,
  init() {
    if(this.initialized) return;
    this.initialized=true;
    this.arena=document.getElementById('bodyArena');
    this.canvas=document.getElementById('bodyTrail');
    this.ctx=this.canvas.getContext('2d');
    this.avatar=document.getElementById('bodyAvatar');
    const w=this.arena.clientWidth, h=400;
    this.canvas.width=w; this.canvas.height=h;
    this.x=w/2; this.y=h/2;
    this.drawAvatar();
    // Keyboard
    document.addEventListener('keydown', e => {
      if(!document.getElementById('sec-body').classList.contains('active')) return;
      if(e.key==='ArrowUp') B.forward(20);
      else if(e.key==='ArrowDown') B.forward(-20);
      else if(e.key==='ArrowLeft') B.turn(-15);
      else if(e.key==='ArrowRight') B.turn(15);
    });
  },
  drawAvatar() {
    const size=18, rad=(this.angle-90)*Math.PI/180;
    this.avatar.style.left=(this.x-size/2)+'px';
    this.avatar.style.top=(this.y-size/2)+'px';
    this.avatar.style.width=size+'px'; this.avatar.style.height=size+'px';
    this.avatar.innerHTML=`<svg width="${size}" height="${size}" viewBox="0 0 20 20"><polygon points="10,0 3,18 10,13 17,18" fill="${this.pen?'#5ce0d6':'#556'}" transform="rotate(${this.angle},10,10)"/></svg>`;
    document.getElementById('bodyInfo').textContent=`Angle: ${((this.angle%360)+360)%360}¬∞ ¬∑ Steps: ${this.steps}`;
  },
  forward(d) {
    const rad=(this.angle-90)*Math.PI/180;
    const nx=this.x+Math.cos(rad)*d, ny=this.y+Math.sin(rad)*d;
    if(this.pen && d>0){
      this.ctx.beginPath();this.ctx.moveTo(this.x,this.y);this.ctx.lineTo(nx,ny);
      this.ctx.strokeStyle='#5ce0d6';this.ctx.lineWidth=2;this.ctx.stroke();
    }
    this.x=nx;this.y=ny;this.steps++;this.drawAvatar();
  },
  turn(deg) { this.angle+=deg; this.drawAvatar(); },
  togglePen() {
    this.pen=!this.pen;
    document.getElementById('bodyPenBtn').textContent=this.pen?'Pen ‚úèÔ∏è':'Pen ‚¨Ü';
    this.drawAvatar();
  },
  clear() {
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    this.x=this.canvas.width/2;this.y=200;this.angle=0;this.steps=0;this.drawAvatar();
  }
};

// ============ MATHLAND (MAZE) ============
const M = {
  canvas:null, ctx:null, initialized:false,
  x:0, y:0, angle:-90,
  walls:[], goalX:0, goalY:0, goalR:20,
  mazeW:0, mazeH:0,
  init() {
    this.canvas=document.getElementById('mazeCanvas');
    this.ctx=this.canvas.getContext('2d');
    this.canvas.width=this.canvas.parentElement.clientWidth;
    this.canvas.height=420;
    this.mazeW=this.canvas.width; this.mazeH=420;
    this.initialized=true;
    this.newMaze();
  },
  newMaze() {
    const w=this.mazeW, h=this.mazeH;
    this.walls=[];
    // Generate a simple maze with walls
    const wallColor='#1a3040';
    // Border
    this.walls.push({x1:0,y1:0,x2:w,y2:0},{x1:w,y1:0,x2:w,y2:h},{x1:w,y1:h,x2:0,y2:h},{x1:0,y1:h,x2:0,y2:0});
    // Internal walls ‚Äî procedural
    const numWalls = 6 + Math.floor(Math.random()*4);
    for(let i=0;i<numWalls;i++){
      const horizontal = Math.random()>0.5;
      if(horizontal){
        const y = 60+Math.random()*(h-120);
        const x1 = Math.random()*w*0.4;
        const x2 = x1+80+Math.random()*200;
        this.walls.push({x1,y1:y,x2:Math.min(x2,w-20),y2:y});
      } else {
        const x = 60+Math.random()*(w-120);
        const y1 = Math.random()*h*0.4;
        const y2 = y1+80+Math.random()*200;
        this.walls.push({x1:x,y1,x2:x,y2:Math.min(y2,h-20)});
      }
    }
    // Start bottom-left, goal top-right
    this.x=50; this.y=h-50; this.angle=-90;
    this.goalX=w-50; this.goalY=50; this.goalR=20;
    document.getElementById('mazeStatus').textContent='';
    document.getElementById('mazeLog').textContent='Navigate to the green circle. Use FD, BK, RT, LT.';
    this.draw();
  },
  draw() {
    const {ctx,canvas:c}=this;
    ctx.clearRect(0,0,c.width,c.height);
    // Walls
    ctx.strokeStyle='#2a4a5a'; ctx.lineWidth=4;
    this.walls.forEach(w=>{ctx.beginPath();ctx.moveTo(w.x1,w.y1);ctx.lineTo(w.x2,w.y2);ctx.stroke();});
    // Goal
    ctx.beginPath();ctx.arc(this.goalX,this.goalY,this.goalR,0,Math.PI*2);
    ctx.fillStyle='rgba(74,222,128,0.2)';ctx.fill();
    ctx.strokeStyle='#4ade80';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#4ade80';ctx.font='12px Georgia';ctx.textAlign='center';
    ctx.fillText('GOAL',this.goalX,this.goalY+4);
    // Turtle
    const rad=(this.angle+90)*Math.PI/180, s=10;
    ctx.save();ctx.translate(this.x,this.y);ctx.rotate(rad);
    ctx.beginPath();ctx.moveTo(0,-s);ctx.lineTo(-s*.6,s*.6);ctx.lineTo(0,s*.3);ctx.lineTo(s*.6,s*.6);ctx.closePath();
    ctx.fillStyle='#5ce0d6';ctx.fill();ctx.restore();
  },
  lineIntersect(x1,y1,x2,y2,x3,y3,x4,y4){
    const d=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);
    if(Math.abs(d)<0.001) return false;
    const t=((x1-x3)*(y3-y4)-(y1-y3)*(x3-x4))/d;
    const u=-((x1-x2)*(y1-y3)-(y1-y2)*(x1-x3))/d;
    return t>=0&&t<=1&&u>=0&&u<=1;
  },
  exec() {
    const input=document.getElementById('mazeCmd').value.trim().toUpperCase();
    if(!input) return;
    const parts=input.split(/\s+/);
    const cmd=parts[0], val=parseFloat(parts[1])||0;
    const log=document.getElementById('mazeLog');

    if(cmd==='RT'||cmd==='RIGHT'){this.angle+=val;log.textContent=`Turned right ${val}¬∞`;this.draw();return;}
    if(cmd==='LT'||cmd==='LEFT'){this.angle-=val;log.textContent=`Turned left ${val}¬∞`;this.draw();return;}
    if(cmd!=='FD'&&cmd!=='FORWARD'&&cmd!=='BK'&&cmd!=='BACK'){log.textContent='Unknown command. Use FD, BK, RT, LT.';return;}

    const d=(cmd==='FD'||cmd==='FORWARD')?val:-val;
    const rad=this.angle*Math.PI/180;
    const nx=this.x+Math.cos(rad)*d, ny=this.y+Math.sin(rad)*d;

    // Check wall collision
    let hit=false;
    for(const w of this.walls){
      if(this.lineIntersect(this.x,this.y,nx,ny,w.x1,w.y1,w.x2,w.y2)){hit=true;break;}
    }
    if(hit){
      log.textContent='üí• Hit a wall! Try a different angle or distance.';
      this.draw();
      return;
    }
    this.x=nx;this.y=ny;
    log.textContent=`Moved ${cmd} ${Math.abs(val)}`;

    // Check goal
    const dx=this.x-this.goalX, dy=this.y-this.goalY;
    if(Math.sqrt(dx*dx+dy*dy)<this.goalR){
      document.getElementById('mazeStatus').textContent='üéâ You reached the goal! Math is your native language.';
    }
    this.draw();
    document.getElementById('mazeCmd').value='';
  },
  reset() {
    this.x=50;this.y=this.mazeH-50;this.angle=-90;
    document.getElementById('mazeStatus').textContent='';
    document.getElementById('mazeLog').textContent='Reset. Try again!';
    this.draw();
  }
};

// ============ BUG AS FEATURE ============
const D = {
  canvas:null, ctx:null,
  init() {
    this.canvas=document.getElementById('debugCanvas');
    this.ctx=this.canvas.getContext('2d');
    this.canvas.width=this.canvas.parentElement.clientWidth||400;
    this.canvas.height=300;
    this.initPuzzles();
  },
  clear() {
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    document.getElementById('debugAnalysis').innerHTML='Run a program to see analysis...';
  },
  run() {
    const code=document.getElementById('debugCode').value;
    this.canvas.width=this.canvas.parentElement.clientWidth||400;
    const ctx=this.ctx;
    ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    let x=this.canvas.width/2, y=this.canvas.height/2, angle=-90, pen=true;
    const cmds=flattenCmds(parseLogo(code));
    let totalDist=0, totalTurn=0, turnCount=0, moveCount=0;
    const points=[{x,y}];

    cmds.forEach(c=>{
      const rad=angle*Math.PI/180;
      if(c.cmd==='FD'||c.cmd==='BK'){
        const d=c.cmd==='FD'?c.val:-c.val;
        const nx=x+Math.cos(rad)*d, ny=y+Math.sin(rad)*d;
        if(pen){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(nx,ny);ctx.strokeStyle='#5ce0d6';ctx.lineWidth=2;ctx.stroke();}
        x=nx;y=ny;totalDist+=Math.abs(d);moveCount++;
        points.push({x,y});
      } else if(c.cmd==='RT'){angle+=c.val;totalTurn+=c.val;turnCount++;}
      else if(c.cmd==='LT'){angle-=c.val;totalTurn-=c.val;turnCount++;}
      else if(c.cmd==='PU')pen=false;
      else if(c.cmd==='PD')pen=true;
    });

    // Analysis
    const closed = points.length>1 && Math.abs(points[0].x-x)<2 && Math.abs(points[0].y-y)<2;
    const totalAngle = ((totalTurn%360)+360)%360;
    const avgTurn = turnCount?Math.abs(totalTurn/turnCount).toFixed(1):0;
    let shape='unknown shape';
    if(closed && Math.abs(totalTurn)===360){
      if(turnCount<=5) shape = `closed ${turnCount}-gon`;
      else if(turnCount>100) shape = 'circle-like curve';
      else shape = `closed ${turnCount}-sided figure`;
    } else if(Math.abs(totalTurn%360)<2 && !closed) {
      shape = 'open path (total turn = '+Math.round(totalTurn)+'¬∞)';
    }

    document.getElementById('debugAnalysis').innerHTML=`
      <div class="panel-title">üî¨ What Your Code Actually Made</div>
      <p><strong>Commands:</strong> ${cmds.length}</p>
      <p><strong>Moves:</strong> ${moveCount} ¬∑ <strong>Turns:</strong> ${turnCount}</p>
      <p><strong>Total distance:</strong> ${totalDist.toFixed(0)}</p>
      <p><strong>Total rotation:</strong> ${totalTurn.toFixed(0)}¬∞</p>
      <p><strong>Avg turn:</strong> ${avgTurn}¬∞</p>
      <p><strong>Closed?</strong> ${closed?'Yes ‚úì':'No ‚úó'}</p>
      <p><strong>Shape:</strong> ${shape}</p>
      <hr style="border-color:var(--border);margin:10px 0;">
      <p style="color:var(--cyan);">üí° <em>${closed?'Your shape closes ‚Äî the turtle returned home.':'The turtle didn\'t return to start. Is that intentional?'}</em></p>
      <p style="margin-top:6px;">${totalTurn===360?'Total turn = 360¬∞ ‚Äî a complete revolution. This is a closed convex shape.':totalTurn===720?'Total turn = 720¬∞ ‚Äî two revolutions. Likely a star or self-crossing polygon.':'Total turn = '+totalTurn.toFixed(0)+'¬∞ ‚Äî '+((totalTurn%360===0&&totalTurn!==0)?'a multiple of 360¬∞ ('+Math.round(totalTurn/360)+' revolutions)':'not a multiple of 360¬∞, so the shape doesn\'t close cleanly.')}</p>
    `;
  },
  puzzles: [
    {
      desc:'This should draw a square:',
      code:'REPEAT 4 [FD 80 RT 80]',
      hint:'What\'s the exterior angle of a square? Walk it out ‚Äî how much do you turn at each corner?',
      explanation:'RT 80 should be RT 90. The program draws a shape that never closes because 4√ó80=320¬∞, not 360¬∞. The total turn must equal 360¬∞ for a closed shape.'
    },
    {
      desc:'This should draw an equilateral triangle:',
      code:'REPEAT 3 [FD 100 RT 60]',
      hint:'Interior angle ‚â† exterior angle. When you walk a triangle and turn at a corner, how much do you actually turn?',
      explanation:'RT 60 uses the interior angle, but the turtle turns by the exterior angle (120¬∞). 3√ó60=180¬∞, not 360¬∞. The turtle only makes half a revolution ‚Äî it draws a straight-ish path.'
    },
    {
      desc:'This should draw a circle but nothing appears:',
      code:'PU\nREPEAT 360 [FD 1 RT 1]',
      hint:'The turtle IS moving... you just can\'t see it. What does PU do?',
      explanation:'PU (pen up) means the turtle moves without drawing. It traced a perfect invisible circle. The program isn\'t wrong ‚Äî it does exactly what you told it.'
    }
  ],
  initPuzzles() {
    const wrap=document.getElementById('debugPuzzles');
    this.puzzles.forEach((p,i)=>{
      const div=document.createElement('div');
      div.style.cssText='margin:12px 0;padding:12px;background:var(--bg3);border-radius:8px;';
      div.innerHTML=`
        <p style="color:var(--text);margin-bottom:6px;">${p.desc}</p>
        <pre class="mono" style="background:var(--bg);padding:10px;border-radius:4px;color:var(--cyan);font-size:0.85rem;">${p.code}</pre>
        <button class="btn-sm" onclick="D.showHint(${i})" style="margin-top:6px;">üí° Hint</button>
        <button class="btn-sm" onclick="D.showAnswer(${i})" style="margin-top:6px;">üîç Explain</button>
        <button class="btn-sm" onclick="document.getElementById('debugCode').value='${p.code.replace(/\n/g,'\\n')}';D.run();" style="margin-top:6px;">‚ñ∂ Run it</button>
        <div id="debugHint${i}" style="display:none;color:var(--orange);font-size:0.82rem;margin-top:8px;"></div>
        <div id="debugAns${i}" style="display:none;color:var(--green);font-size:0.82rem;margin-top:8px;"></div>
      `;
      wrap.appendChild(div);
    });
  },
  showHint(i){document.getElementById('debugHint'+i).style.display='block';document.getElementById('debugHint'+i).textContent='üí° '+this.puzzles[i].hint;},
  showAnswer(i){document.getElementById('debugAns'+i).style.display='block';document.getElementById('debugAns'+i).textContent='üîç '+this.puzzles[i].explanation;}
};

// ============ MICROWORLD BUILDER ============
const MW = {
  canvas:null, ctx:null,
  init() {
    this.canvas=document.getElementById('microCanvas');
    this.ctx=this.canvas.getContext('2d');
    this.canvas.width=this.canvas.parentElement.clientWidth||400;
    this.canvas.height=400;
    document.getElementById('microCode').value='REPEAT 4 [FD 100 RT 90]';
  },
  updateLabel() {
    ['FdMul','FdCurve','RtMul','RtDrift','Random','Shrink'].forEach(k=>{
      const el=document.getElementById('mw'+k);
      document.getElementById('mw'+k+'V').textContent=parseFloat(el.value).toFixed(k==='Shrink'?3:1);
    });
  },
  preset(name) {
    const p={
      euclidean:{FdMul:1,FdCurve:0,RtMul:1,RtDrift:0,Random:0,Shrink:1},
      hyperbolic:{FdMul:0.8,FdCurve:0.5,RtMul:1.2,RtDrift:0,Random:0,Shrink:0.998},
      spherical:{FdMul:1,FdCurve:0.3,RtMul:0.8,RtDrift:0.2,Random:0,Shrink:1},
      drunk:{FdMul:1,FdCurve:0,RtMul:1,RtDrift:0,Random:0.5,Shrink:1},
      spiral:{FdMul:1,FdCurve:0,RtMul:1,RtDrift:0,Random:0,Shrink:0.99},
      mirror:{FdMul:1,FdCurve:-0.5,RtMul:1.5,RtDrift:0.3,Random:0.1,Shrink:1},
    }[name];
    if(!p)return;
    Object.keys(p).forEach(k=>{document.getElementById('mw'+k).value=p[k];});
    this.updateLabel();
    this.run();
  },
  clear() {
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
  },
  run() {
    this.canvas.width=this.canvas.parentElement.clientWidth||400;
    const ctx=this.ctx;
    ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    const code=document.getElementById('microCode').value;
    const cmds=flattenCmds(parseLogo(code));
    const fdMul=parseFloat(document.getElementById('mwFdMul').value);
    const fdCurve=parseFloat(document.getElementById('mwFdCurve').value);
    const rtMul=parseFloat(document.getElementById('mwRtMul').value);
    const rtDrift=parseFloat(document.getElementById('mwRtDrift').value);
    const rnd=parseFloat(document.getElementById('mwRandom').value);
    const shrink=parseFloat(document.getElementById('mwShrink').value);

    let x=this.canvas.width/2, y=this.canvas.height/2, angle=-90, pen=true, scale=1;
    ctx.strokeStyle='#5ce0d6'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(x,y);

    cmds.forEach(c=>{
      const noise=()=>(Math.random()-0.5)*2*rnd*20;
      if(c.cmd==='FD'||c.cmd==='BK'){
        const d=(c.cmd==='FD'?c.val:-c.val)*fdMul*scale+noise();
        // Curvature: split into micro-steps
        const steps=Math.max(1,Math.ceil(Math.abs(d)/3));
        const stepD=d/steps;
        const curvePer=fdCurve*0.5;
        for(let s=0;s<steps;s++){
          const rad=angle*Math.PI/180;
          const nx=x+Math.cos(rad)*stepD, ny=y+Math.sin(rad)*stepD;
          if(pen){ctx.lineTo(nx,ny);}
          x=nx;y=ny;angle+=curvePer;
        }
        scale*=shrink;
      } else if(c.cmd==='RT'){
        angle+=c.val*rtMul+noise();
        const rad=angle*Math.PI/180;
        x+=Math.cos(rad)*rtDrift*10;y+=Math.sin(rad)*rtDrift*10;
      } else if(c.cmd==='LT'){
        angle-=c.val*rtMul+noise();
        const rad=angle*Math.PI/180;
        x+=Math.cos(rad)*rtDrift*10;y+=Math.sin(rad)*rtDrift*10;
      } else if(c.cmd==='PU')pen=false;
      else if(c.cmd==='PD')pen=true;
    });
    ctx.stroke();
  }
};

// ============ JUGGLING ============
const J = {
  step:0, playing:false, timer:null,
  beats:[
    {instruction:'RIGHT hand: TOSS ball A upward-left', balls:[{x:220,y:230,c:'#f87171'},{x:180,y:260,c:'#5ce0d6'},{x:220,y:260,c:'#a78bfa'}], note:'Scoop up with right hand and release at ~45¬∞. The ball should peak at eye level and land in the LEFT hand.'},
    {instruction:'Ball A rising... LEFT hand prepares', balls:[{x:195,y:160,c:'#f87171'},{x:180,y:260,c:'#5ce0d6'},{x:220,y:260,c:'#a78bfa'}], note:'Watch the peak, not your hands. Your left hand opens slightly. The timing gap between throw and catch is where the "frame" lives.'},
    {instruction:'Ball A peaks ‚Äî LEFT hand: TOSS ball B', balls:[{x:180,y:130,c:'#f87171'},{x:185,y:190,c:'#5ce0d6'},{x:220,y:260,c:'#a78bfa'}], note:'As A reaches peak, toss B from left hand upward-right. This is the hardest moment ‚Äî you must throw BEFORE you catch. Counter-intuitive!'},
    {instruction:'LEFT hand catches A ‚Äî Ball B rising', balls:[{x:175,y:240,c:'#f87171'},{x:210,y:140,c:'#5ce0d6'},{x:220,y:260,c:'#a78bfa'}], note:'Left hand catches A. Ball B is now in the air heading right. The gap between "throw B" and "catch A" is tiny ‚Äî structured programming helps you sequence it.'},
    {instruction:'Ball B peaks ‚Äî RIGHT hand: TOSS ball C', balls:[{x:175,y:260,c:'#f87171'},{x:220,y:130,c:'#5ce0d6'},{x:215,y:190,c:'#a78bfa'}], note:'Same pattern on the other side. Right hand tosses C before catching B. The procedure is symmetric: TOSS then CATCH, TOSS then CATCH.'},
    {instruction:'RIGHT catches B ‚Äî Ball C rising', balls:[{x:175,y:260,c:'#f87171'},{x:225,y:240,c:'#5ce0d6'},{x:190,y:140,c:'#a78bfa'}], note:'Right hand catches B. Now you\'re back to the starting configuration but shifted: A in left, B in right, C in the air.'},
    {instruction:'CYCLE COMPLETE ‚Äî REPEAT', balls:[{x:180,y:260,c:'#f87171'},{x:220,y:260,c:'#5ce0d6'},{x:180,y:170,c:'#a78bfa'}], note:'One full cycle! The cascade is just REPEAT FOREVER [TOSS_RIGHT, TOSS_LEFT]. Each toss is a sub-procedure. Papert\'s insight: breaking it into steps makes the impossible learnable.'},
  ],
  draw() {
    const canvas=document.getElementById('juggleCanvas');
    const ctx=canvas.getContext('2d');
    canvas.width=canvas.parentElement.clientWidth||400;
    canvas.height=320;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2, scale=canvas.width/400;

    // Body
    ctx.strokeStyle='#556';ctx.lineWidth=3;
    // Torso
    ctx.beginPath();ctx.moveTo(cx,120*scale);ctx.lineTo(cx,220*scale);ctx.stroke();
    // Head
    ctx.beginPath();ctx.arc(cx,100*scale,20*scale,0,Math.PI*2);ctx.stroke();
    // Arms
    ctx.beginPath();ctx.moveTo(cx,150*scale);ctx.lineTo((cx-60*scale),240*scale);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx,150*scale);ctx.lineTo((cx+60*scale),240*scale);ctx.stroke();
    // Hands
    ctx.fillStyle='#88a0b8';
    ctx.beginPath();ctx.arc(cx-60*scale,245*scale,8*scale,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+60*scale,245*scale,8*scale,0,Math.PI*2);ctx.fill();

    // Balls
    const beat=this.beats[this.step];
    beat.balls.forEach(b=>{
      const bx=cx+(b.x-200)*scale, by=b.y*scale;
      ctx.beginPath();ctx.arc(bx,by,12*scale,0,Math.PI*2);
      ctx.fillStyle=b.c;ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1;ctx.stroke();
    });

    // Arc paths (faint)
    ctx.setLineDash([4,4]);ctx.strokeStyle='rgba(92,224,214,0.15)';ctx.lineWidth=1;
    ctx.beginPath();ctx.ellipse(cx,180*scale,50*scale,70*scale,0,0,Math.PI*2);ctx.stroke();
    ctx.setLineDash([]);

    // Step indicator
    document.getElementById('juggleStep').innerHTML=
      `<strong>Beat ${this.step+1}/${this.beats.length}:</strong> ${beat.instruction}<br><span style="color:var(--muted);font-size:0.82rem;">${beat.note}</span>`;
  },
  next(){this.step=Math.min(this.step+1,this.beats.length-1);this.draw();},
  prev(){this.step=Math.max(this.step-1,0);this.draw();},
  togglePlay(){
    this.playing=!this.playing;
    document.getElementById('jugglePlayBtn').textContent=this.playing?'‚è∏ Pause':'‚ñ∂ Play';
    if(this.playing){
      this.timer=setInterval(()=>{
        this.step=(this.step+1)%this.beats.length;
        this.draw();
      },1200);
    } else clearInterval(this.timer);
  },
  reset(){this.step=0;this.playing=false;clearInterval(this.timer);document.getElementById('jugglePlayBtn').textContent='‚ñ∂ Play';this.draw();}
};

// ============ OBJECT-TO-THINK-WITH ============
const OBJ = {
  items: [
    {name:'Variable', icon:'üì¶', desc:'A box you can put numbers in and take them out', id:'variable'},
    {name:'Function', icon:'üé∞', desc:'A machine: put something in, get something out', id:'function'},
    {name:'Recursion', icon:'ü™û', desc:'A mirror reflecting a mirror ‚Äî a thing defined in terms of itself', id:'recursion'},
    {name:'Loop', icon:'üîÑ', desc:'Walking in circles ‚Äî but each lap does something', id:'loop'},
    {name:'Conditional', icon:'üö¶', desc:'A fork in the road ‚Äî go left or right based on a question', id:'conditional'},
  ],
  current: null,
  init() {
    const wrap=document.getElementById('objCards');
    this.items.forEach((item,i)=>{
      const card=document.createElement('div');
      card.className='obj-card';card.id='objCard'+i;
      card.innerHTML=`<h4>${item.icon} ${item.name}</h4><p>${item.desc}</p>`;
      card.onclick=()=>this.select(i);
      wrap.appendChild(card);
    });
  },
  select(i) {
    document.querySelectorAll('.obj-card').forEach(c=>c.classList.remove('active'));
    document.getElementById('objCard'+i).classList.add('active');
    this.current=i;
    const canvas=document.getElementById('objCanvas');
    canvas.style.display='block';
    canvas.width=canvas.parentElement.clientWidth-40;
    canvas.height=280;
    this['draw_'+this.items[i].id](canvas);
  },
  draw_variable(canvas) {
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2;
    document.getElementById('objTitle').textContent='üì¶ Variable: A Box with a Name';
    // Draw boxes
    const boxes=[{name:'x',val:7,x:cx-120},{name:'name',val:'"Ada"',x:cx},{name:'total',val:42,x:cx+120}];
    boxes.forEach(b=>{
      ctx.strokeStyle='var(--cyan)';ctx.lineWidth=2;
      ctx.strokeRect(b.x-40,80,80,60);
      ctx.fillStyle='#5ce0d6';ctx.font='bold 14px Georgia';ctx.textAlign='center';
      ctx.fillText(b.name,b.x,72);
      ctx.fillStyle='#ddd';ctx.font='20px Courier New';
      ctx.fillText(b.val,b.x,118);
    });
    // Arrow showing reassignment
    ctx.fillStyle='var(--orange)';ctx.font='14px Georgia';
    ctx.fillText('x = 7',cx-120,180);
    ctx.fillText('x = x + 3',cx-120,200);
    ctx.fillText('x is now 10',cx-120,220);
    document.getElementById('objControls').innerHTML='<button class="btn" onclick="OBJ.animateVariable()">‚ñ∂ Watch x change</button>';
    document.getElementById('objExplain').innerHTML='A variable is a labeled box. You can look inside (read), put something new in (assign), or use what\'s inside in a calculation. The name stays the same ‚Äî the contents change. <em>This is the object Papert wanted children to touch before they see "let x = 7" in a textbook.</em>';
  },
  animateVariable() {
    const canvas=document.getElementById('objCanvas');
    const ctx=canvas.getContext('2d');
    const cx=canvas.width/2-120;
    let val=7, step=0;
    const steps=[7,8,9,10];
    const timer=setInterval(()=>{
      ctx.fillStyle='var(--bg3)';ctx.fillRect(cx-40,80,80,60);
      ctx.strokeStyle='var(--cyan)';ctx.lineWidth=2;ctx.strokeRect(cx-40,80,80,60);
      ctx.fillStyle='#ddd';ctx.font='20px Courier New';ctx.textAlign='center';
      ctx.fillText(steps[step],cx,118);
      step++;
      if(step>=steps.length)clearInterval(timer);
    },500);
  },
  draw_function(canvas) {
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2;
    document.getElementById('objTitle').textContent='üé∞ Function: A Machine';
    // Machine
    ctx.fillStyle='#1a3040';
    ctx.fillRect(cx-60,60,120,100);
    ctx.strokeStyle='#5ce0d6';ctx.lineWidth=2;ctx.strokeRect(cx-60,60,120,100);
    ctx.fillStyle='#5ce0d6';ctx.font='bold 14px Georgia';ctx.textAlign='center';
    ctx.fillText('DOUBLE',cx,115);
    // Input
    ctx.fillStyle='var(--orange)';ctx.font='18px Courier New';
    ctx.fillText('5 ‚Üí',cx-90,110);
    // Output
    ctx.fillStyle='var(--green)';
    ctx.fillText('‚Üí 10',cx+90,110);
    // More examples
    ctx.fillStyle='var(--muted)';ctx.font='13px Georgia';
    ctx.fillText('3 ‚Üí DOUBLE ‚Üí 6',cx,190);
    ctx.fillText('100 ‚Üí DOUBLE ‚Üí 200',cx,210);
    ctx.fillText('-4 ‚Üí DOUBLE ‚Üí -8',cx,230);
    document.getElementById('objControls').innerHTML='<input type="text" id="fnInput" placeholder="Type a number" style="width:120px;display:inline-block;" onkeydown="if(event.key===\'Enter\')OBJ.runFn()"> <button class="btn" onclick="OBJ.runFn()">Feed the machine</button> <span id="fnOutput" style="color:var(--green);margin-left:8px;"></span>';
    document.getElementById('objExplain').innerHTML='A function is a machine. Feed it input, get output. The machine\'s rules are fixed ‚Äî same input always gives same output. <em>You understand functions by feeding them things and watching what comes out.</em>';
  },
  runFn() {
    const v=parseFloat(document.getElementById('fnInput').value);
    if(isNaN(v)){document.getElementById('fnOutput').textContent='Feed it a number!';return;}
    document.getElementById('fnOutput').textContent=`DOUBLE(${v}) = ${v*2}`;
  },
  draw_recursion(canvas) {
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2;
    document.getElementById('objTitle').textContent='ü™û Recursion: Mirrors All the Way Down';
    // Draw nested squares
    function drawNested(x,y,size,depth) {
      if(depth<=0||size<5) return;
      ctx.strokeStyle=`hsl(${170+depth*15},70%,${40+depth*8}%)`;
      ctx.lineWidth=1.5;ctx.strokeRect(x-size/2,y-size/2,size,size);
      drawNested(x,y,size*0.7,depth-1);
    }
    drawNested(cx,140,200,8);
    ctx.fillStyle='var(--muted)';ctx.font='13px Georgia';ctx.textAlign='center';
    ctx.fillText('Each square contains a smaller version of itself',cx,260);
    document.getElementById('objControls').innerHTML='<button class="btn" onclick="OBJ.drawTree()">üå≥ Recursive Tree</button>';
    document.getElementById('objExplain').innerHTML='Recursion: a thing defined in terms of itself. A folder contains folders. A story within a story. A mirror facing a mirror. <em>The turtle can call itself ‚Äî TO TREE: FD 20 RT 30 TREE LT 60 TREE. Each branch grows branches.</em>';
  },
  drawTree() {
    const canvas=document.getElementById('objCanvas');
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    function branch(x,y,angle,len,depth) {
      if(depth<=0||len<3)return;
      const rad=angle*Math.PI/180;
      const nx=x+Math.cos(rad)*len, ny=y+Math.sin(rad)*len;
      ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(nx,ny);
      ctx.strokeStyle=`hsl(${140+depth*10},60%,${30+depth*7}%)`;ctx.lineWidth=depth*0.8;ctx.stroke();
      branch(nx,ny,angle-25,len*0.7,depth-1);
      branch(nx,ny,angle+25,len*0.7,depth-1);
    }
    branch(canvas.width/2,canvas.height-10,-90,60,8);
  },
  draw_loop(canvas) {
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2;
    document.getElementById('objTitle').textContent='üîÑ Loop: Repetition with Purpose';
    // Draw spiral showing loop iterations
    ctx.strokeStyle='#5ce0d6';ctx.lineWidth=2;
    let x=cx,y=140,angle=0;
    for(let i=0;i<100;i++){
      const rad=angle*Math.PI/180;
      const nx=x+Math.cos(rad)*3, ny=y+Math.sin(rad)*3;
      ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(nx,ny);
      ctx.strokeStyle=`hsl(${170+i},70%,50%)`;ctx.stroke();
      x=nx;y=ny;angle+=15;
    }
    // Labels
    ctx.fillStyle='var(--muted)';ctx.font='13px Georgia';ctx.textAlign='center';
    ctx.fillText('REPEAT 100 [FD 3 RT 15]',cx,260);
    ctx.fillText('Same instruction, 100 times ‚Üí emergent spiral',cx,278);
    document.getElementById('objControls').innerHTML='';
    document.getElementById('objExplain').innerHTML='A loop does the same thing over and over ‚Äî but the <em>context</em> changes each time. The turtle is in a new position, facing a new direction. Simple repetition creates complex form. <em>This is how children discover that patterns emerge from rules.</em>';
  },
  draw_conditional(canvas) {
    const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2;
    document.getElementById('objTitle').textContent='üö¶ Conditional: The Fork in the Road';
    // Decision tree
    ctx.fillStyle='#5ce0d6';ctx.font='bold 14px Georgia';ctx.textAlign='center';
    ctx.fillText('Is it raining?',cx,40);
    // Diamond
    ctx.beginPath();ctx.moveTo(cx,55);ctx.lineTo(cx+40,80);ctx.lineTo(cx,105);ctx.lineTo(cx-40,80);ctx.closePath();
    ctx.strokeStyle='#5ce0d6';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#5ce0d6';ctx.font='12px Georgia';ctx.fillText('?',cx,84);
    // Yes branch
    ctx.beginPath();ctx.moveTo(cx-40,80);ctx.lineTo(cx-100,130);ctx.stroke();
    ctx.fillStyle='var(--green)';ctx.fillText('YES',cx-75,100);
    ctx.fillRect(cx-140,130,80,35);ctx.fillStyle='var(--bg)';ctx.fillText('Take umbrella',cx-100,152);
    // No branch
    ctx.beginPath();ctx.moveTo(cx+40,80);ctx.lineTo(cx+100,130);ctx.strokeStyle='#5ce0d6';ctx.stroke();
    ctx.fillStyle='var(--red)';ctx.fillText('NO',cx+75,100);
    ctx.fillStyle='var(--orange)';ctx.fillRect(cx+60,130,80,35);ctx.fillStyle='var(--bg)';ctx.fillText('Wear sunglasses',cx+100,152);

    document.getElementById('objControls').innerHTML='';
    document.getElementById('objExplain').innerHTML='A conditional asks a yes/no question and takes different paths. IF...THEN...ELSE. The computer (and the child) learns that decisions are just forks ‚Äî question, path A, path B. <em>Every complex behavior is built from simple decisions.</em>';
  }
};

// ============ INIT ============
T.init();
D.init();
MW.init();
OBJ.init();
J.draw();
</script>
</body>
</html>
